{% extends "base.html.j2" %}

{% block title %}Página de Upload{% endblock %}

{% block body %}
<div x-data="{
    loading: false,
    file: null,
    fileInfo: '',
    handleFile(event) {
      const file = event?.dataTransfer?.files?.[0] || event?.target?.files?.[0];
      if (!file) return;

      // Atualiza o input real para que o arquivo seja enviado corretamente
      const dataTransfer = new DataTransfer();
      dataTransfer.items.add(file);
      this.$refs.fileInput.files = dataTransfer.files;

      // Atualiza dados no front
      this.file = file;
      const sizeMB = (file.size / (1024 * 1024)).toFixed(2);
      this.fileInfo = `${file.name} - ${sizeMB} MB`;

      if (file.type === 'application/pdf') {
        const reader = new FileReader();
        reader.onload = () => {
          const typedarray = new Uint8Array(reader.result);
          pdfjsLib.getDocument({ data: typedarray }).promise.then(pdf => {
            this.fileInfo += ` - ${pdf.numPages} página(s)`;
          });
        };
        reader.readAsArrayBuffer(file);
      }
    }
  }">

  <!-- Overlay de carregamento -->
  <div id="overlay" x-show="loading" class="flex">Carregando...</div>

  <!-- Cabeçalho -->
  <header class="p-4 bg-blue-500 text-white">
    <h1 class="text-center text-2xl">Upload de Arquivo</h1>
  </header>

  <!-- Área principal -->
  <main class="p-4">
    <form id="uploadForm" method="POST" enctype="multipart/form-data" action="{{ url_for('upload') }}"
      @submit="loading = true">
      <!-- Área de drag'n drop -->
      <div x-on:click="$refs.fileInput.click()" x-on:dragover.prevent="$el.classList.add('bg-gray-200')"
        x-on:dragleave.prevent="$el.classList.remove('bg-gray-200')"
        x-on:drop.prevent="$el.classList.remove('bg-gray-200'); handleFile($event)" x-ref="fileInput"
        @change="handleFile($event)"
        class="border-dashed border-4 border-gray-400 flex justify-center items-center my-4 h-[40vh] relative"
        id="uploadArea">
        <input type="file" name="file" x-ref="fileInput" class="hidden" @change="handleFile($event)">
        <div class="text-center">
          <template x-if="!file">
            <span>Arraste e solte ou clique para selecionar um arquivo</span>
          </template>
          <template x-if="file">
            <span x-text="fileInfo"></span>
          </template>
        </div>
      </div>

      <!-- Botões -->
      <div>
        <button type="submit" class="bg-blue-500 text-white p-2" :disabled="!file">
          Enviar
        </button>
      </div>
    </form>
  </main>
</div>
{% endblock %}